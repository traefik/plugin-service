version: v1.0
name: Plugin service - Vercel
agent:
  machine:
    type: e1-standard-4
    os_image: ubuntu1804

fail_fast:
  stop:
    when: "branch != 'master'"

auto_cancel:
  queued:
    when: "branch != 'master'"
  running:
    when: "branch != 'master'"

global_job_config:
  secrets:
    - name: vercel-plugin-config
  prologue:
    commands:
      - sem-version node 14.1.0
      - npm install -g vercel@latest
      - checkout
      - mkdir -p $(pwd)/.vercel
      - cp /home/semaphore/datas/project.json $(pwd)/.vercel/project.json
blocks:
  - name: Generate token and restart vercel service
    dependencies: []
    run:
      when: "branch = 'master'"
    task:
      jobs:
        - name: Run
          commands:
            - |
              TOKEN=$(curl -s --request POST --url https://sso.traefik.io/oauth/token --header 'content-type: application/json' --data @/home/semaphore/datas/data.json | jq -r .access_token | tr -d '\n' | base64)
            - echo ${TOKEN}
            - vercel secrets rm pilot-plugin-access-token --token ${VERCEL_TOKEN} --scope traefiklabs --yes
            - vercel secrets add pilot-plugin-access-token "${TOKEN}" --token ${VERCEL_TOKEN} --scope traefiklabs
            - vercel --token ${VERCEL_TOKEN} --scope traefiklabs --prod
